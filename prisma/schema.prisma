generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  profileImage        String?
  createdAt           DateTime             @default(now())
  agreeToTerms        Boolean?
  company             String?
  firstName           String?
  lastName            String?
  onboardingComplete  Boolean              @default(false)
  updatedAt           DateTime             @updatedAt
  name                String?
  invitationsSent     Invitation[]         @relation("InvitedByUser")
  notifications       Notification[]
  passwordResetTokens PasswordResetToken[]
  profile             UserProfile?
  workspaces          WorkspaceUser[]
}

model Workspace {
  id            String          @id @default(uuid())
  name          String
  invitations   Invitation[]
  labels        Label[]
  notifications Notification[]
  reports       Report[]
  users         WorkspaceUser[]
}

model WorkspaceUser {
  id          String    @id @default(uuid())
  userId      String
  workspaceId String
  role        Role
  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Label {
  id          String         @id @default(uuid())
  name        String
  fileUrl     String
  workspaceId String
  isDemo      Boolean        @default(false)
  workspace   Workspace      @relation(fields: [workspaceId], references: [id])
  versions    LabelVersion[]
}

model LabelVersion {
  id             String      @id @default(uuid())
  labelId        String
  extraction     Json
  analyzedAt     DateTime    @default(now())
  compliantItems Json?
  overallScore   Int?
  nextSteps      Json?
  status         LabelStatus
  reviewComment  String?
  approvedAt     DateTime?
  approvedBy     String?
  rejectedAt     DateTime?
  rejectedBy     String?
  label          Label       @relation(fields: [labelId], references: [id])
  violations     Violation[]
}

model Violation {
  id           String       @id @default(uuid())
  versionId    String
  type         String
  message      String
  suggestion   String
  citation     String
  category     String?      @default("General")
  location     String?
  severity     String?      @default("medium")
  labelVersion LabelVersion @relation(fields: [versionId], references: [id])
}

model Report {
  id                  String    @id @default(uuid())
  name                String
  type                String
  status              String    @default("generating")
  workspaceId         String
  generatedAt         DateTime  @default(now())
  dateRange           Json
  filters             Json
  summary             Json?
  downloadUrl         String?
  expiresAt           DateTime?
  progress            Int       @default(0)
  estimatedCompletion DateTime?
  workspace           Workspace @relation(fields: [workspaceId], references: [id])
}

model UserProfile {
  id                String            @id @default(uuid())
  userId            String            @unique
  companyType       CompanyType
  teamSize          TeamSize
  labelsPerMonth    LabelsPerMonth
  goals             Goals[]
  complianceProcess ComplianceProcess
  user              User              @relation(fields: [userId], references: [id])
}

model Invitation {
  id          String    @id @default(uuid())
  email       String
  workspaceId String
  role        Role
  status      String    @default("invited")
  invitedAt   DateTime  @default(now())
  invitedById String
  acceptedAt  DateTime?
  expiresAt   DateTime  @default(dbgenerated("(now() + '2 days'::interval)"))
  token       String
  invitedBy   User      @relation("InvitedByUser", fields: [invitedById], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  workspaceId String?
  type        NotificationType
  title       String
  message     String
  data        Json?
  read        Boolean          @default(false)
  readAt      DateTime?
  createdAt   DateTime         @default(now())
  expiresAt   DateTime?
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace?       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([workspaceId])
}

enum Role {
  ADMIN
  REVIEWER
  VIEWER
}

enum LabelStatus {
  SCANNED
  PENDING
  APPROVED
  REJECTED
}

enum CompanyType {
  FOOD_MANUFACTURER
  SUPPLEMENT_MANUFACTURER
  BEVERAGE_COMPANY
  REGULATORY_CONSULTANT
  OTHER
}

enum TeamSize {
  JUST_ME
  TWO_TO_FIVE
  SIX_TO_TWENTY
  TWENTY_PLUS
}

enum LabelsPerMonth {
  ONE_TO_FIVE
  SIX_TO_TWENTY
  TWENTY_ONE_TO_FIFTY
  FIFTY_PLUS
}

enum Goals {
  REDUCE_COSTS
  SPEED_LAUNCH
  AVOID_WARNING_LETTERS
  IMPROVE_ACCURACY
  STREAMLINE_WORKFLOW
  ALL_OF_THE_ABOVE
}

enum ComplianceProcess {
  EXTERNAL_CONSULTANTS
  IN_HOUSE_TEAM
  MANUAL_REVIEW
  NO_FORMAL_PROCESS
}

enum NotificationType {
  LABEL_ANALYZED
  LABEL_APPROVED
  LABEL_REJECTED
  COMPLIANCE_ISSUE
  WORKSPACE_INVITE
  INVITE_ACCEPTED
  REPORT_GENERATED
  REPORT_FAILED
  SYSTEM_UPDATE
  WORKSPACE_ACTIVITY
}
